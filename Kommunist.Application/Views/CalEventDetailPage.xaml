<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Kommunist.Application.Views.CalEventDetailPage"
    x:Name="Page"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:models="clr-namespace:Kommunist.Application.Models"
    xmlns:viewModels="clr-namespace:Kommunist.Application.ViewModels"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:DataType="{x:Type viewModels:EventCalendarDetailViewModel}"
    xmlns:helpers="clr-namespace:Kommunist.Application.Helpers"
    Style="{StaticResource DefaultPageStyle}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
            <Style x:Key="SectionHeaderStyle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="Margin" Value="0,10,0,5" />
            </Style>
            <Style x:Key="EventCardStyle" TargetType="Border">
                <Setter Property="Stroke" Value="{DynamicResource BorderColor}" />
                <Setter Property="StrokeShape" Value="RoundRectangle 12" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="BackgroundColor" Value="{DynamicResource BorderBackgroundColor}" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="{DynamicResource BorderShadowColor}"
                                Offset="0,2"
                                Radius="4"
                                Opacity="0.5" />
                    </Setter.Value>
                </Setter>
            </Style>
            <Style x:Key="SeparatorStyle" TargetType="BoxView">
                <Setter Property="Color" Value="{DynamicResource BoxViewColor}" />
                <Setter Property="HeightRequest" Value="1" />
                <Setter Property="Margin" Value="0,10,0,10" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="15" Padding="16">
                <!-- Event Header Card -->
                <Border Style="{StaticResource EventCardStyle}">
                    <Grid>
                        <Image
                            Aspect="AspectFill"
                            BackgroundColor="SkyBlue"
                            HeightRequest="120"
                            Opacity="0.5"
                            Source="{Binding Source={x:Reference Page}, Path=BgImg}" />
                        <VerticalStackLayout Padding="16" Spacing="8">
                            <Label Text="{Binding SelectedEventDetail.Title, FallbackValue='', TargetNullValue=''
}"
                                   FontAttributes="Bold"
                                   FontSize="24"
                                   LineBreakMode="WordWrap"
                                   HorizontalTextAlignment="Center" />
                            
                            <Label Text="{Binding SelectedEventDetail.PeriodDateTime, FallbackValue='', TargetNullValue=''}"
                                   FontSize="16"
                                   LineBreakMode="WordWrap"
                                   HorizontalTextAlignment="Center" />
                                   
                            <Label HorizontalTextAlignment="Center" FontSize="16">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span FontFamily="FAS" Text="{DynamicResource IconTowerBroadcast}" />
                                        <Span Text=" " />
                                        <Span Text="{Binding SelectedEventDetail.FormatEvent, FallbackValue='', TargetNullValue=''}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <!-- Event Details Card -->
                <Border Style="{StaticResource EventCardStyle}">
                    <VerticalStackLayout Padding="16" Spacing="12">
                        <!-- Event Info -->
                        <FlexLayout JustifyContent="SpaceEvenly" Wrap="Wrap">
                            <VerticalStackLayout>
                                <Label HorizontalOptions="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span FontFamily="FAS" Text="{DynamicResource IconLanguage}" FontSize="24" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding SelectedEventDetail.Language, FallbackValue='', TargetNullValue=''}" 
                                       HorizontalOptions="Center"
                                       FontSize="14" />
                            </VerticalStackLayout>
                            
                            <VerticalStackLayout>
                                <Label HorizontalOptions="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span FontFamily="FAS" Text="{DynamicResource IconLocationPin}" FontSize="24" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding SelectedEventDetail.Location, FallbackValue='', TargetNullValue=''}" 
                                       HorizontalOptions="Center"
                                       FontSize="14" />
                            </VerticalStackLayout>
                            
                            <VerticalStackLayout>
                                <Label HorizontalOptions="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span FontFamily="FAS" Text="{DynamicResource IconCalendar}" FontSize="24" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding SelectedEventDetail.Date, FallbackValue='', TargetNullValue=''}" 
                                       HorizontalOptions="Center"
                                       FontSize="14" />
                            </VerticalStackLayout>
                        </FlexLayout>
                        
                        <BoxView Style="{StaticResource SeparatorStyle}" />
                        
                        <!-- Add to Calendar Button -->
                        <Button Text="Add to Calendar" 
                                BackgroundColor="{DynamicResource Primary}"
                                TextColor="White"
                                HorizontalOptions="Fill"
                                CornerRadius="8"
                                Command="{Binding AddToCalendar}"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Description Card -->
                <Border Style="{StaticResource EventCardStyle}" 
                        IsVisible="{Binding SelectedEventDetail.Description, FallbackValue='', TargetNullValue='', Converter={StaticResource BooleanToVisibilityConverter}}">
                    <VerticalStackLayout Padding="16" Spacing="10">
                        <Label Text="Description" 
                               Style="{StaticResource SectionHeaderStyle}" />
                               
                        <BoxView Style="{StaticResource SeparatorStyle}" />
                        

                        <WebView x:Name="DescriptionWebView"
                                 IsVisible="{Binding SelectedEventDetail.Description, FallbackValue='', TargetNullValue='', Converter={StaticResource BooleanToVisibilityConverter}}"
                                 VerticalOptions="FillAndExpand"
                                 Navigating="DescriptionWebView_Navigating">
                            <WebView.Source>
                                <HtmlWebViewSource Html="{Binding SelectedEventDetail.Description, FallbackValue='', TargetNullValue=''}" />
                            </WebView.Source>
                        </WebView>

                        <!-- Overlay loading spinner -->
                        <ActivityIndicator IsRunning="{Binding IsWebViewLoading}" 
                                           IsVisible="{Binding IsWebViewLoading}"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           InputTransparent="True" />
                    </VerticalStackLayout>
                </Border>

                <!-- Participants Card -->
                <Border Style="{StaticResource EventCardStyle}"
                        IsVisible="{Binding HasParticipants}">
                    <Grid RowDefinitions="Auto,Auto,*" Padding="16">
                        <Label Text="Participants" 
                               Style="{StaticResource SectionHeaderStyle}"
                               Grid.Row="0" />
                               
                        <BoxView Style="{StaticResource SeparatorStyle}" Grid.Row="1" />
                        
                        <!-- Participants Grid -->
                        <Grid ColumnDefinitions="*,*" Grid.Row="2">
                            <!-- Speakers Column -->
                            <VerticalStackLayout Grid.Column="0" IsVisible="{Binding SelectedEventDetail.Speakers, FallbackValue='', TargetNullValue='', Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Label Text="Speakers"
                                       Style="{StaticResource SectionHeaderStyle}" />
                                       
                                <CollectionView ItemsSource="{Binding SelectedEventDetail.Speakers, FallbackValue='', TargetNullValue=''}"
                                                ItemsLayout="VerticalGrid, 1"
                                                EmptyView="No speakers available">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="{x:Type models:PersonCard}">
                                            <Border Style="{StaticResource EventCardStyle}" 
                                                    Margin="2,5" 
                                                    Padding="10">
                                                <VerticalStackLayout Spacing="5" HorizontalOptions="Center">
                                                    <Border HeightRequest="60" 
                                                           WidthRequest="60" 
                                                           Padding="0"
                                                           HorizontalOptions="Center">
                                                        <Image Aspect="AspectFill"
                                                               Source="{Binding Avatar}" />
                                                        <Border.StrokeShape>
                                                            <RoundRectangle CornerRadius="30" />
                                                        </Border.StrokeShape>
                                                    </Border>
                                                    <Label Text="{Binding Name}" 
                                                           FontAttributes="Bold" 
                                                           HorizontalOptions="Center"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                    <Label Text="{Binding Company}" 
                                                           FontSize="12" 
                                                           HorizontalOptions="Center"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                    <Label Text="{Binding Position}" 
                                                           FontSize="12" 
                                                           HorizontalOptions="Center"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                </VerticalStackLayout>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>

                            <!-- Moderators Column -->
                            <VerticalStackLayout Grid.Column="1" IsVisible="{Binding SelectedEventDetail.Moderators, FallbackValue='', TargetNullValue='', Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Label Text="Moderators"
                                       Style="{StaticResource SectionHeaderStyle}" />
                                       
                                <CollectionView ItemsSource="{Binding SelectedEventDetail.Moderators, FallbackValue='', TargetNullValue=''}"
                                                ItemsLayout="VerticalGrid, 1"
                                                EmptyView="No moderators available">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="{x:Type models:PersonCard}">
                                            <Border Style="{StaticResource EventCardStyle}" 
                                                    Margin="2,5" 
                                                    Padding="10">
                                                <VerticalStackLayout Spacing="5" HorizontalOptions="Center">
                                                    <Border HeightRequest="60" 
                                                            WidthRequest="60" 
                                                            StrokeShape="RoundRectangle 30"
                                                            HorizontalOptions="Center">
                                                        <Image Aspect="AspectFill"
                                                               Source="{Binding Avatar}" />
                                                    </Border>
                                                    <Label Text="{Binding Name}" 
                                                           FontAttributes="Bold" 
                                                           HorizontalOptions="Center"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                    <Label Text="{Binding Company}" 
                                                           FontSize="12" 
                                                           HorizontalOptions="Center"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                    <Label Text="{Binding Position}" 
                                                           FontSize="12" 
                                                           HorizontalOptions="Center"
                                                           LineBreakMode="TailTruncation"
                                                           MaxLines="1" />
                                                </VerticalStackLayout>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </Grid>
                    </Grid>
                </Border>
                
                <!-- Join Event Button -->
                <Button Text="Join Event" 
                        BackgroundColor="{DynamicResource Success}"
                        TextColor="White"
                        FontAttributes="Bold"
                        FontSize="16"
                        HorizontalOptions="Fill"
                        CornerRadius="8"
                        HeightRequest="50"
                        Margin="0,5,0,15"
                        Command="{Binding JoinToEvent}"/>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>