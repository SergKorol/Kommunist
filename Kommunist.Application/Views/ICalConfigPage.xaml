<?xml version="1.0" encoding="utf-8"?>

<controls:MyTabBar xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:Kommunist.Application.ViewModels"
             xmlns:controls="clr-namespace:Kommunist.Application.Controls"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:helpers="clr-namespace:Kommunist.Application.Helpers"
             x:Class="Kommunist.Application.Views.ICalConfigPage"
             x:DataType="{x:Type viewModels:ICalConfigViewModel}"
             Style="{StaticResource DefaultPageStyle}"
             Title="iCal Configuration"
             ControlTemplate="{StaticResource SecondaryColorTemplate}">
       <controls:MyTabBar.Resources>
           <helpers:BoolToColorConverter x:Key="BoolToColorConverter"/>
           <helpers:HasItemsConverter x:Key="HasItemsConverter" />
       </controls:MyTabBar.Resources>
       <controls:MyTabBar.Content>
        <Grid RowDefinitions="Auto,*" RowSpacing="0">
            <!-- Content -->
            <ScrollView Grid.Row="1" Margin="0,25,0,0">
                <VerticalStackLayout Padding="20,0,20,20" Spacing="0">
                    <!-- Main Card -->
                    <Border Style="{StaticResource CardStyle}">
                        <VerticalStackLayout Spacing="10">
                            <!-- Email Section -->
                            <Label Text="Email" Style="{StaticResource LabelStyle}"/>
                            <Border Style="{StaticResource BorderedEntryContainerStyle}">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Entry Grid.Column="0"
                                           Text="{Binding Invitees, Mode=TwoWay}"
                                           Placeholder="example@email.com"
                                           Keyboard="Email"
                                           TextChanged="OnAlarmEmailChanged"
                                           Style="{StaticResource EntryStyle}">
                                        <Entry.Behaviors>
                                            <toolkit:EmailValidationBehavior
                                                InvalidStyle="{StaticResource InvalidEntryStyle}"
                                                ValidStyle="{StaticResource ValidEntryStyle}"
                                                Flags="ValidateOnValueChanged"/>
                                        </Entry.Behaviors>
                                    </Entry>
                                    <Image Grid.Column="1" 
                                           Source="email_icon.png" 
                                           HeightRequest="20" 
                                           WidthRequest="20"
                                           VerticalOptions="Center" 
                                           HorizontalOptions="End"
                                           Margin="0,0,5,0"
                                           IsVisible="True"/>
                                </Grid>
                            </Border>

                            <!-- Delivery Options -->
                            <Label Text="Delivery Options" Style="{StaticResource LabelStyle}" Margin="5,10,0,10"/>
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                <Border Grid.Column="0"
                                        Style="{StaticResource CardStyle}"
                                        Padding="10"
                                        Margin="0,0,5,0"
                                        BackgroundColor="{Binding SendEmail, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#EAE8FD|White'}">
                                    <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                                        <CheckBox IsChecked="{Binding SendEmail}"
                                                  Style="{StaticResource CustomCheckBoxStyle}"/>
                                        <Label Text="Send Email"
                                               Style="{StaticResource CheckboxLabelStyle}"/>
                                    </HorizontalStackLayout>
                                </Border>
                                <Border Grid.Column="1"
                                        Style="{StaticResource CardStyle}"
                                        Padding="10"
                                        Margin="5,0,0,0"
                                        BackgroundColor="{Binding SaveFile, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#EAE8FD|White'}">
                                    <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                                        <CheckBox IsChecked="{Binding SaveFile}"
                                                  Style="{StaticResource CustomCheckBoxStyle}"/>
                                        <Label Text="Save File"
                                               Style="{StaticResource CheckboxLabelStyle}"/>
                                    </HorizontalStackLayout>
                                </Border>
                            </Grid>

                            <!-- Alarm Section -->
                            <Label Text="Alarm (minutes before event)" Style="{StaticResource LabelStyle}" Margin="5,20,0,5"/>
                            <Border Style="{StaticResource BorderedEntryContainerStyle}">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Entry Grid.Column="0"
                                           Text="{Binding AlarmMinutes}"
                                           Keyboard="Numeric"
                                           Placeholder="10"
                                           MaxLength="3"
                                           TextChanged="OnAlarmMinutesChanged"
                                           Style="{StaticResource EntryStyle}"/>
                                           
                                    <HorizontalStackLayout Grid.Column="1" 
                                                       HorizontalOptions="End" 
                                                       VerticalOptions="Center"
                                                       Spacing="8">
                                        <Button Text="âˆ’" 
                                                FontSize="18"
                                                WidthRequest="36"
                                                HeightRequest="36"
                                                CornerRadius="18"
                                                Command="{Binding DecrementAlarmCommand}"
                                                BackgroundColor="{DynamicResource DecrementBackgroundButtonColor}"
                                                TextColor="{DynamicResource TextColor}"
                                                FontAttributes="Bold"
                                                Padding="0"/>
                                        <Button Text="+" 
                                                FontSize="18"
                                                WidthRequest="36"
                                                HeightRequest="36"
                                                CornerRadius="18"
                                                Command="{Binding IncrementAlarmCommand}"
                                                BackgroundColor="{DynamicResource IncrementBackgroundButtonColor}"
                                                TextColor="{DynamicResource TextColor}"
                                                FontAttributes="Bold"
                                                Padding="0"
                                                Margin="0,0,5,0"/>
                                    </HorizontalStackLayout>
                                </Grid>
                            </Border>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Event Summary Card (Optional) -->
                    <Border Style="{StaticResource CardStyle}" IsVisible="{Binding Events, Converter={StaticResource HasItemsConverter}}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Event Summary" Style="{StaticResource LabelStyle}" FontSize="18"/>
                            <Label Text="{Binding Events.Count, StringFormat='{0} events selected'}"
                                   TextColor="{DynamicResource TextColor}"
                                   FontSize="15"
                                   Margin="0,0,0,5"/>
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="5">
                                <Label Grid.Row="0" Grid.Column="0" Text="Start:" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}"/>
                                <Label Grid.Row="0" Grid.Column="1" Text="{Binding FirstEventDateTime}" TextColor="{DynamicResource LabelTextColor}"/>
                                <Label Grid.Row="1" Grid.Column="0" Text="End:" FontAttributes="Bold" TextColor="{DynamicResource LabelTextColor}"/>
                                <Label Grid.Row="1" Grid.Column="1" Text="{Binding LastEventDateTime}" TextColor="{DynamicResource LabelTextColor}"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>
                    
                    <!-- Generate Button -->
                    <Button Text="Generate iCal"
                            Command="{Binding GenerateIcalCommand}"
                            Style="{StaticResource PrimaryButtonStyle}"/>
                    
                    <!-- Info Card -->
                    <Border Style="{StaticResource CardStyle}" Margin="0,15,0,10">
                        <VerticalStackLayout Spacing="10">
                            <Label Text="About iCal Files" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource TextColor}"/>
                            <Label Text="iCal files (.ics) can be imported into most calendar applications including Google Calendar, Apple Calendar, and Microsoft Outlook."
                                   TextColor="#666666"
                                   FontSize="14"/>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </ScrollView>
        </Grid>
    </controls:MyTabBar.Content>
</controls:MyTabBar>