<Project>
    <PropertyGroup>
        <BlobConnectionString>$(BLOB_CONNECTION_STRING)</BlobConnectionString>
        <DefineConstants>$(DefineConstants);HAS_BLOB_SECRET</DefineConstants>
    </PropertyGroup>

    <Target Name="UpdateConnectionString" BeforeTargets="BeforeBuild" Condition="'$(BlobConnectionString)' != ''">
        <Message Text="Updating connection string in Secrets.cs" Importance="high" />
        <WriteLinesToFile
                File="$(MSBuildThisFileDirectory)/Secrets.cs"
                Lines="$([System.IO.File]::ReadAllText('$(MSBuildThisFileDirectory)/Secrets.cs').Replace('__BLOB_CONNECTION_STRING__', '$(BlobConnectionString)'))"
                Overwrite="true" />
    </Target>

    <!-- Include Secrets.cs as a project item -->
    <ItemGroup>
        <Compile Include="$(MSBuildThisFileDirectory)/Secrets.cs">
            <Link>Build/Secrets.cs</Link>
            <Visible>true</Visible>
        </Compile>
    </ItemGroup>
</Project>